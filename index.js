var gulp=require("gulp"),grunseq=new function(){function n(){var n=Array.prototype.slice.call(arguments),r=popLastCallback(n);TaskManager.startTasks(n,r)}function r(n){var r=TaskManager.getInfoByRunningTask(n);return null!=r?new Ender(r,n):new NoWaitEnder(n)}this.start=n,this.ender=r};module.exports=grunseq;function popLastCallback(n){return 0===n.length||"function"!=typeof n[n.length-1]?EMPTY_FN:n.pop()}function fnCall(n){var t=Array.prototype.slice.call(arguments,1);"function"==typeof n&&n.apply(null,t)}var EMPTY_FN=function(){},isEmptyObject=function(n){return 0===Object.keys(n).length};var EndTaskManager=new function(){function n(n,a){var e=gulp.tasks[n],u=t[n];u&&(e.hrDuration=process.hrtime(u)),r.call(gulp,gulp.tasks[n],"",a)}function a(a,e,u,t){fnCall(e,t,u),a in s&&(delete s[a],n(a,u))}function e(n){return n in u}this.endTask=a,this.isRunnedTask=e;var u={},s={},t={},i=gulp._runTask;gulp._runTask=function(n){u[n.name]=!0,s[n.name]=!0,t[n.name]=process.hrtime(),i.apply(gulp,arguments)};var r=gulp._emitTaskDone;gulp._emitTaskDone=function(){}};var TaskManager=new function(){function n(){}function r(n){for(var r=0;r<k.length;r++)if(k[r].runner===n)return k[r];return null}function t(n){for(var r=0;r<k.length;r++){var t=k[r];if(n in t.running)return t}return null}function i(n){var r=k.indexOf(n);r>=0&&k.splice(r,1)}function u(r,t){var i=new n,u={runner:i,tasks:r,running:{},callback:t};return k.unshift(u),u}function e(n){if(0===n.tasks.length)return i(n),void fnCall(n.callback);var r=n.tasks.shift();Array.isArray(r)||(r=[r]);for(var t=[],u=0;u<r.length;u++){var a=r[u];"string"==typeof a&&(EndTaskManager.isRunnedTask(a)||(t.push(a),n.running[a]={}))}return 0===t.length?void e(n):void gulp.start.call(n.runner,t)}function a(n,r,t,i){return null!=n&&"running"in n&&r in n.running?isEmptyObject(n.running[r])?(delete n.running[r],EndTaskManager.endTask(r,t,i,!0),!0):!1:(EndTaskManager.endTask(r,t,i,!0),!1)}function s(n,r,t,i){if(null!=n&&r in n.running)for(var u=n.running[r],e=0;e<t.length;e++)u[t[e]]=i}function l(n,r,t,i,u,e){if(fnCall(i,!0,e),null==n||!(r in n.running))return!1;var a=EMPTY_FN;return t in n.running[r]?(a=n.running[r][t],delete n.running[r][t],isEmptyObject(n.running[r])&&(delete n.running[r],EndTaskManager.endTask(r,a,u,!0)),!0):!1}function g(n){return isEmptyObject(n.running)}function o(n,r){var t=u(n,r);return e(t),t}function f(n,r,t,i){a(n,r,t,i)&&g(n)&&e(n)}function c(n,r,t,i,u,a){l(n,r,t,i,u,a)&&g(n)&&e(n)}this.startTasks=o,this.endTask=f,this.waitTask=s,this.notifyTask=c,this.getInfoByRunner=r,this.getInfoByRunningTask=t,this.log=function(){console.log("TaskManager = [");for(var n=0;n<k.length;n++)console.log(k[n]);console.log("]")};var k=[];n.prototype=gulp};function Ender(n,t){function r(r,u,e){return e&&(a=e),TaskManager.notifyTask(n,t,r,u,a,e),i}var a=null,i=function(r,a){TaskManager.endTask(n,t,r,a)};return i.with=function(n){return function(t){i(n,t)}},i.wait=function(){var r=Array.prototype.slice.call(arguments),a=popLastCallback(r);return TaskManager.waitTask(n,t,r,a),i},i.notify=r,i.notifier=function(n,t){return function(a){return r(n,t,a)}},i}function NoWaitEnder(n){function t(n,t,a){return fnCall(t,!1,a),r}var r=function(t,r){EndTaskManager.endTask(n,t,r,!1)};return r.with=function(n){return function(t){r(n,t)}},r.wait=function(){var n=Array.prototype.slice.call(arguments),t=popLastCallback(n);return t(!1),r},r.notify=t,r.notifier=function(n,r){return function(a){return t(n,r,a)}},r}var originalTaskFn=gulp.task;gulp.task=function(n,r,e){var u,a;if(Array.isArray(r)&&1===r.length&&Array.isArray(r[0])){var s=r[0];a=e?e.length>0?function(){var r=grunseq.ender(n);s.push(function(n){e(r),fnCall(n)}),grunseq.start.apply(grunseq,s)}:function(){var r=grunseq.ender(n);s.push(function(){e(),r()}),grunseq.start.apply(grunseq,s)}:function(){var r=grunseq.ender(n);s.push(function(){r()}),grunseq.start.apply(grunseq,s)}}else e||"function"!=typeof r||(e=r,r=void 0),u=r,a=e?e.length>0?function(r){e(grunseq.ender(n)),fnCall(r)}:function(){e(),grunseq.ender(n)()}:function(){grunseq.ender(n)()};return originalTaskFn.call(gulp,n,u,a)};