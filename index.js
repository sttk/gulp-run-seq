var gulp=require("gulp"),grunseq=new function(){function n(){var n=Array.prototype.slice.call(arguments),r=popLastCallback(n);TaskManager.startTasks(n,r)}function r(n){var r=TaskManager.getInfoByRunningTask(n);return null!=r?new Ender(r,n):new NoWaitEnder(n)}this.start=n,this.ender=r};module.exports=grunseq;function popLastCallback(n){return 0===n.length||"function"!=typeof n[n.length-1]?EMPTY_FN:n.pop()}function fnCall(n){var t=Array.prototype.slice.call(arguments,1);"function"==typeof n&&n.apply(null,t)}var EMPTY_FN=function(){},isEmptyObject=function(n){return 0===Object.keys(n).length};var TaskStatus=new function(){function t(t){fnCall(l,{task:t}),i[t]=process.hrtime()}function s(t,s){var n=gulp.tasks[t],a=i[t];a&&(n.hrDuration=process.hrtime(a)),k.call(gulp,gulp.tasks[t],"",s)}function n(t,n,a,e){fnCall(n,e,a),t in u&&(delete u[t],s(t,a))}function a(t){return t in e}this.startTask=t,this.endTask=n,this.isRunnedTask=a;var e={},u={},i={},r=gulp._runTask,l=null;gulp._runTask=function(t){this._events.task_start!==EMPTY_FN&&(l||(l=this._events.task_start),this._events.task_start=EMPTY_FN),e[t.name]=!0,u[t.name]=!0,i[t.name]=process.hrtime(),r.apply(gulp,arguments)};var k=gulp._emitTaskDone;gulp._emitTaskDone=function(){}};var TaskManager=new function(){function n(){}function r(n){for(var r=0;r<k.length;r++)if(k[r].runner===n)return k[r];return null}function t(n){for(var r=0;r<k.length;r++){var t=k[r];if(n in t.running)return t}return null}function i(n){var r=k.indexOf(n);r>=0&&k.splice(r,1)}function u(r,t){var i=new n,u={runner:i,tasks:r,running:{},callback:t};return k.unshift(u),u}function e(n){if(0===n.tasks.length)return i(n),void fnCall(n.callback);var r=n.tasks.shift();Array.isArray(r)||(r=[r]);for(var t=[],u=0;u<r.length;u++){var a=r[u];"string"==typeof a&&(TaskStatus.isRunnedTask(a)||(t.push(a),n.running[a]={}))}return 0===t.length?void e(n):void gulp.start.call(n.runner,t)}function a(n,r,t,i){return null!=n&&"running"in n&&r in n.running?isEmptyObject(n.running[r])?(delete n.running[r],TaskStatus.endTask(r,t,i,!0),!0):!1:(TaskStatus.endTask(r,t,i,!0),!1)}function s(n,r,t,i){if(null!=n&&r in n.running)for(var u=n.running[r],e=0;e<t.length;e++)u[t[e]]=i}function l(n,r,t,i,u,e){if(fnCall(i,!0,e),null==n||!(r in n.running))return!1;var a=EMPTY_FN;return t in n.running[r]?(a=n.running[r][t],delete n.running[r][t],isEmptyObject(n.running[r])&&(delete n.running[r],TaskStatus.endTask(r,a,u,!0)),!0):!1}function o(n){return isEmptyObject(n.running)}function g(n,r){var t=u(n,r);return e(t),t}function f(n,r,t,i){a(n,r,t,i)&&o(n)&&e(n)}function c(n,r,t,i,u,a){l(n,r,t,i,u,a)&&o(n)&&e(n)}this.startTasks=g,this.endTask=f,this.waitTask=s,this.notifyTask=c,this.getInfoByRunner=r,this.getInfoByRunningTask=t,this.log=function(){console.log("TaskManager = [");for(var n=0;n<k.length;n++)console.log(k[n]);console.log("]")};var k=[];n.prototype=gulp};function Ender(n,t){function r(r,i,o){return o&&(a=o),TaskManager.notifyTask(n,t,r,i,a,o),u}var a=null,u=function(r,a){TaskManager.endTask(n,t,r,a)};return u.with=function(n){return function(t){u(n,t)}},u.wait=function(){var r=Array.prototype.slice.call(arguments),a=popLastCallback(r);return TaskManager.waitTask(n,t,r,a),u},u.notify=r,u.notifier=function(n,t){return function(a){return r(n,t,a)}},u}function NoWaitEnder(n){function t(n,t,a){return fnCall(t,!1,a),r}var r=function(t,r){TaskStatus.endTask(n,t,r,!1)};return r.with=function(n){return function(t){r(n,t)}},r.wait=function(){var n=Array.prototype.slice.call(arguments),t=popLastCallback(n);return t(!1),r},r.notify=t,r.notifier=function(n,r){return function(a){return t(n,r,a)}},r}var originalTaskFn=gulp.task;gulp.task=function(n,r,u){function a(){TaskStatus.startTask(n)}var e;if(Array.isArray(r)&&1===r.length&&Array.isArray(r[0])){var s=r[0];return e=u?u.length>0?function(){var r=grunseq.ender(n);s.push(function(n){a(),u(r),fnCall(n)}),grunseq.start.apply(grunseq,s)}:function(){var r=grunseq.ender(n);s.push(function(){a(),u(),r()}),grunseq.start.apply(grunseq,s)}:function(){var r=grunseq.ender(n);s.push(function(){a(),r()}),grunseq.start.apply(grunseq,s)},originalTaskFn.call(gulp,n,void 0,e)}if(u||"function"!=typeof r||(u=r,r=void 0),null==r||0===r.length)return e=u?u.length>0?function(r){var e=grunseq.ender(n);a(),u(e),fnCall(r)}:function(){var r=grunseq.ender(n);a(),u(),r()}:function(){var r=grunseq.ender(n);a(),r()},originalTaskFn.call(gulp,n,r,e);var t=[r];return e=u?u.length>0?function(){var r=grunseq.ender(n);t.push(function(n){a(),u(r),fnCall(n)}),grunseq.start.apply(grunseq,t)}:function(){var r=grunseq.ender(n);t.push(function(){a(),u(),r()}),grunseq.start.apply(grunseq,t)}:function(){var r=grunseq.ender(n);t.push(function(){a(),r()}),grunseq.start.apply(grunseq,t)},originalTaskFn.call(gulp,n,void 0,e)};